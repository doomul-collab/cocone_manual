<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Guest List | Cocone House</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 700px; margin: auto; padding: 20px; line-height: 1.6; color: #222; background-color: #fff; }
  h1 { text-align: center; font-size: 1.5rem; margin-bottom: 1.5rem; }
  .desc-container { background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 2rem; border: 1px solid #d1e7ff; }
  .desc-line { display: block; margin: 12px 0; font-size: 1rem; color: #1a1a1a; }
  label { display: block; margin-top: 25px; font-weight: bold; font-size: 1.1rem; color: #000; }
  input { width: 100%; padding: 14px; margin-top: 8px; border: 2px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
  input:focus { border-color: #007bff; outline: 3px solid rgba(0,123,255,0.2); }
  button { margin-top: 25px; padding: 18px; width: 100%; border: none; border-radius: 10px; background: #222; color: #fff; font-size: 1.2rem; cursor: pointer; font-weight: bold; min-height: 50px; }
  .section { margin-top: 2.5rem; padding: 25px; border: 1px solid #ddd; border-radius: 12px; background-color: #fcfcfc; }
  .btn-add { background: #5a6268; }
  .btn-submit { background: #007bff; margin-bottom: 60px; }
  .photo-help { font-size: 0.9rem; color: #d9534f; margin-top: 8px; display: block; }
</style>
</head>
<body>

<main>
  <h1 tabindex="0">Guest List Registration</h1>

  <div class="desc-container" role="region" aria-label="Information">
    <p class="desc-line">일본 법에 따라 숙박자 명부 작성이 의무화되어 있습니다.</p>
    <p class="desc-line">Registration is required by Japanese law.</p>
  </div>

  <form id="guestForm" enctype="multipart/form-data">
    <section class="section">
      <h2>Main Guest (代表者)</h2>

      <label for="main_name">성함 Full Name (氏名)</label>
      <input type="text" id="main_name" name="성함" required aria-required="true">

      <label for="main_nat">국적 Nationality (国籍)</label>
      <input type="text" id="main_nat" name="국적">

      <label for="main_passport">여권번호 Passport Number</label>
      <input type="text" id="main_passport" name="여권번호">

      <label for="main_phone">전화번호 Phone Number</label>
      <input type="tel" id="main_phone" name="전화번호" required aria-required="true">

      <label for="main_checkin">체크인 날짜 Check-in</label>
      <input type="date" id="main_checkin" name="체크인_날짜" required aria-required="true">

      <label for="main_checkout">체크아웃 날짜 Check-out</label>
      <input type="date" id="main_checkout" name="체크아웃_날짜" required aria-required="true">

      <label for="main_photo">여권 사진 첨부 Passport Photo</label>
      <span class="photo-help">여권의 인적사항 페이지를 찍어주세요.</span>
      <input type="file" id="main_photo" name="여권_사진" accept="image/*" required>
    </section>

    <div id="companions_area"></div>

    <button type="button" class="btn-add" onclick="addCompanion()">
      동반자 추가 (Add companion)
    </button>
    
    <button type="submit" class="btn-submit">
      등록하기 (Submit)
    </button>
  </form>
</main>

<script>
// 1. 구글 시트 Apps Script 주소
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxh0csTv5HxeG0QAHT9kxqd1hsOkXiP0WkPH83zv_JUh8iQFJszAzbnQUq7J94juaVu/exec";
// 2. Formspree 주소
const FORMSPREE_URL = "https://formspree.io/f/xregnbbl";

let compCount = 0;
function addCompanion(){
  if(compCount >= 4){ alert("최대 4명까지 추가 가능합니다."); return; }
  compCount++;
  const area = document.getElementById("companions_area");
  const div = document.createElement("section");
  div.className = "section";
  div.innerHTML = `
    <h3>Companion #${compCount}</h3>
    <label>성함 Full Name</label>
    <input type="text" name="동반자${compCount}_이름" required>
    <label>여권번호 Passport</label>
    <input type="text" name="동반자${compCount}_여권번호">
    <label>여권 사진</label>
    <input type="file" name="동반자${compCount}_사진" accept="image/*">
  `;
  area.appendChild(div);
}

document.getElementById('guestForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  // 버튼 비활성화
  const submitBtn = document.querySelector('.btn-submit');
  submitBtn.disabled = true;
  submitBtn.innerText = "전송 중... (Sending...)";

  try {
    // 1. 구글 시트로 데이터 전송 (텍스트만)
    const googleData = new URLSearchParams();
    for (const pair of formData.entries()) {
      if (!(pair[1] instanceof File)) {
        googleData.append(pair[0], pair[1]);
      }
    }
    await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      body: googleData,
      mode: 'no-cors'
    });

    // 2. Formspree로 데이터 전송 (사진 포함 전체)
    const response = await fetch(FORMSPREE_URL, {
      method: 'POST',
      body: formData,
      headers: { 'Accept': 'application/json' }
    });

    if (response.ok) {
      alert("등록이 완료되었습니다. 감사합니다!\nRegistration complete. Thank you!");
      location.reload();
    } else {
      throw new Error('Formspree 전송 실패');
    }
  } catch (error) {
    console.error(error);
    alert("오류가 발생했습니다. 다시 시도해주세요.");
    submitBtn.disabled = false;
    submitBtn.innerText = "등록하기 (Submit)";
  }
});
</script>
</body>
</html>