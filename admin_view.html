<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>宿泊者名簿管理 | Cocone House</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; margin: 20px; background: #f4f7f6; }
  h1 { color: #333; font-size: 1.5rem; border-left: 5px solid #007bff; padding-left: 15px; }
  .controls { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .filter-group { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  button { padding: 10px 15px; border: none; border-radius: 4px; background: #007bff; color: white; cursor: pointer; font-weight: bold; }
  button:hover { background: #0056b3; }
  button.secondary { background: #6c757d; }
  input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
  table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 0.85rem; }
  th { background-color: #f8f9fa; color: #333; white-space: nowrap; }
  tr:nth-child(even) { background-color: #f9f9f9; }
  .passport-img { width: 80px; height: auto; cursor: pointer; border-radius: 4px; border: 1px solid #ddd; }
  .role-main { color: #d9534f; font-weight: bold; background: #fff5f5; padding: 2px 5px; border-radius: 3px; }
  .role-comp { color: #5bc0de; background: #f0faff; padding: 2px 5px; border-radius: 3px; }
</style>
</head>
<body>

<h1>宿泊者名簿管理システム</h1>

<div class="controls">
  <div class="filter-group">
    <button onclick="setPeriod(7)">過去1週間</button>
    <button onclick="setPeriod(30)">過去1ヶ月</button>
    <button onclick="setPeriod(365)">過去1年</button>
    <button class="secondary" onclick="fetchAll()">すべて表示</button>
  </div>
  <div class="filter-group">
    <label>期間指定: </label>
    <input type="date" id="startDate"> ～ <input type="date" id="endDate">
    <button onclick="fetchDataByRange()">検索</button>
  </div>
</div>

<table id="guestTable">
  <thead>
    <tr>
      <th>登録日時</th>
      <th>区分</th>
      <th>氏名</th>
      <th>国籍</th>
      <th>旅券番号</th>
      <th>宿泊期間</th>
      <th>パスポート写し</th>
    </tr>
  </thead>
  <tbody>
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// 사용자님의 Supabase 접속 정보 유지
const SUPABASE_URL = "https://mtviblngovojyljonltq.supabase.co";
const SUPABASE_KEY = "sb_publishable_sJ4BTJ4wm1Nx1Mzelrj0rQ_mdDvqXLG";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 버튼 클릭 시 날짜 설정
function setPeriod(days) {
  const end = new Date();
  const start = new Date();
  start.setDate(end.getDate() - days);
  
  document.getElementById('startDate').value = start.toISOString().split('T')[0];
  document.getElementById('endDate').value = end.toISOString().split('T')[0];
  fetchDataByRange();
}

// 전체 데이터 조회
async function fetchAll() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  const { data, error } = await supabaseClient
    .from('guests')
    .select('*')
    .order('created_at', { ascending: false });
  
  if (error) {
    alert("データの取得中にエラーが発生しました: " + error.message);
  } else {
    renderTable(data);
  }
}

// 기간 검색 조회
async function fetchDataByRange() {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  
  if(!start || !end) {
    alert("開始日と終了日を正しく選択してください。");
    return;
  }

  const { data, error } = await supabaseClient
    .from('guests')
    .select('*')
    .gte('created_at', `${start}T00:00:00`)
    .lte('created_at', `${end}T23:59:59`)
    .order('created_at', { ascending: false });

  if (error) {
    alert("検索中にエラーが発生しました: " + error.message);
  } else {
    renderTable(data);
  }
}

// 테이블 렌더링
function renderTable(data) {
  const tbody = document.querySelector('#guestTable tbody');
  tbody.innerHTML = '';
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">該当するデータがありません。</td></tr>';
    return;
  }

  data.forEach(guest => {
    const row = document.createElement('tr');
    // 일본 날짜 형식으로 변환
    const date = new Date(guest.created_at).toLocaleString('ja-JP');
    const roleText = guest.role === 'main' ? '<span class="role-main">代表者</span>' : '<span class="role-comp">同伴者</span>';
    
    row.innerHTML = `
      <td>${date}</td>
      <td>${roleText}</td>
      <td><strong>${guest.name}</strong></td>
      <td>${guest.nationality || '-'}</td>
      <td>${guest.passport_no || '-'}</td>
      <td>${guest.checkin} ～ ${guest.checkout}</td>
      <td>
        ${guest.passport_url ? `<img src="${guest.passport_url}" class="passport-img" onclick="window.open(this.src)" title="クリックして拡大">` : '画像なし'}
      </td>
    `;
    tbody.appendChild(row);
  });
}

// 초기 로딩 시 실행
fetchAll();
</script>
</body>
</html>